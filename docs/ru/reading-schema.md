# Чтение схемы данных

Cycle ORM в своей работе полагается на схему,
представленную в виде объекта, реализующего интерфейс `\Cycle\ORM\SchemaInterface`.

Поскольку исходные данные для схемы представляют из себя массив определённой структуры,
мы можем хранить схему в кеше или в файле текстового формата.

Посмотреть используемую в вашем проекте схему вы можете с помощью консольной команды `cycle/schema`.

В пакете `yii-cycle` схему из разных источников предоставляют разные поставщики, реализующие интерфейс
`SchemaProviderInterface`. Согласно интерфейсу, поставщик опционально может не только предоставлять (читать) схему из
своего хранилища, но и сохранять (перезаписывать) её там. Определить список и порядок поставщиков схемы вы можете в
опции `schema-providers` файла `config/params.php`.

Список поставщиков обрабатывается в классе `SchemaManager` следующим образом:

- Менеджер обходит список поставщиков, запрашивая схему.
- Если поставщик предоставляет схему, то обход списка прекращается.
- Полученная схема передаётся опрошенным поставщикам, которые не смогли предоставить схему.
- Если ни один поставщик не предоставил схему, то будет выброшено исключение.

## Схема из аннотаций сущностей

По умолчанию схема собирается на основе аннотаций сущностей вашего проекта.

В процессе сборки схемы последовательно запускаются генераторы. Очерёдность запуска определяется в объекте,
реализующем интерфейс `SchemaConveyorInterface`. Вы можете внедрить свои генераторы в конвейер, определив их в
опции `annotated-entity-paths` файла `config/params.php`.

Для получения схемы из конвейера используется провайдер `FromConveyorSchemaProvider`.

Процесс сборки схемы из аннотаций относительно ресурсоёмкий и может значительно влиять на производительность
приложения. Поэтому вкупе с аннотациями рекомендуется настроить кеширование схемы.

## Кеширование схемы

Запись и чтение схемы в кеш осуществляет поставщик `SimpleCacheSchemaProvider`.

Разместите его в начале списка поставщиков, чтобы значительно ускорить процесс получения схемы.

## Схема в файле

Если вы желаете избежать использования аннотаций для описания схемы, то можно описать её в PHP-файле.
Используйте поставщика `FromFilesSchemaProvider` для загрузки схемы из PHP-файла:

```php
# Файл config/common.php
return [
    // ...
    'yiisoft/yii-cycle' => [
        // ...
        'schema-providers' => [
            \Yiisoft\Yii\Cycle\Schema\Provider\FromFilesSchemaProvider::class => [
                'files' => ['@runtime/schema.php']
            ]
        ],
    ]
];
```

```php
# Файл runtime/schema.php
use Cycle\ORM\Schema;
return [
   'user' => [
        Schema::MAPPER      => \Cycle\ORM\Mapper\Mapper::class,
        Schema::ENTITY      => \App\Entity\User::class,
        Schema::DATABASE    => 'default',
        Schema::TABLE       => 'users',
        Schema::PRIMARY_KEY => 'id',
        Schema::COLUMNS     => [
           'id'   => 'id',
           'name' => 'name'
        ],
        Schema::TYPECAST    => [
           'id' => 'int'
        ],
        Schema::RELATIONS   => []
    ]
];
```

Обратите внимание: 

1. Поставщик `FromFilesSchemaProvider` загружает схему из PHP-файлов выражением `require`, что само по себе
   не безопасно. Храните файлы схемы в безопасном и ограниченном от потенциального воздействия пользователей месте.
2. При получении готовой схемы из файлов нет необходимости её собирать из аннотаций, а значит и включение поставщика
   `FromConveyorSchemaProvider` скорее всего будет бессмысленным.
3. За счёт внутренних механизмов кеширования загрузка схемы из PHP-файла происходит настолько быстро, что вы можете
   не использовать внешние механизмы кеширования.
4. Миграции на основе схемы из файла генерироваться не будут. [Issue #25](https://github.com/yiisoft/yii-cycle/issues/25)
5. Поставщик работает только на чтение схемы. Это значит, что он не сотрёт файл после применения миграции и 
   не перезапишет в него новую схему.

## Перенос схемы из аннотаций в файл

Для экспорта схемы в виде PHP можно воспользоваться консольной командой `cycle/schema/php`.
Укажите первым параметром имя файла и схема запишется в него:

```bash
cycle/schema/php @runtime/schema.php
```

Псевдоним `@runtime` автоматически раскроется в соответствующее значение и схема запишется в указанный
файл `schema.php`.

Убедитесь, что экспортированная схема не содержит ошибок, а затем назначьте на предоставление схемы из файла
поставщика `FromFilesSchemaProvider`.

Вы можете комбинировать оба способа описания схемы: при разработке используйте аннотации и генерируйте на их основе
миграции; для production переносите схему в файл.
